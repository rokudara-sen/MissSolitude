@layout LoginLayout
@inject NavigationManager NavigationManager
@page "/login"
@using System.ComponentModel.DataAnnotations
@using MissSolitude.Contracts
@inject HttpClient HttpClient

<PageTitle>Sign In</PageTitle>

<div class="auth-layout">
    <div class="auth-card">
        
        <div class="auth-header">
            <h1>Welcome back</h1>
            <p>Please enter your details to sign in.</p>
        </div>

        <EditForm Model="_login" OnValidSubmit="@ValidateUser">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="field">
                <label for="email">Email Address</label>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="20" height="16" x="2" y="4" rx="2" />
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                    </svg>
                    
                    <InputText id="email"
                               type="email"
                               @bind-Value="_login.Identifier"
                               class="input"
                               placeholder="name@company.com"
                               autocomplete="email" />
                </div>
                <ValidationMessage For="@(() => _login.Identifier)" />
            </div>

            <div class="field">
                <label for="password">Password</label>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>

                    <InputText id="password"
                               type="password"
                               @bind-Value="_login.Password"
                               class="input"
                               placeholder="Enter your password"
                               autocomplete="current-password" />
                </div>
                <ValidationMessage For="@(() => _login.Password)" />
            </div>

            <div class="field-inline">
                <label class="checkbox-wrap">
                    <input type="checkbox" @bind="_rememberMe" />
                    <span>Remember me</span>
                </label>

                <a href="#" class="link-reset">Forgot password?</a>
            </div>

            <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                @_buttonText
            </button>
            
            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <p class="error">@_error</p>
            }

            @if (_loginResponse is not null)
            {
                <div class="success">
                    <p>Signed in as @_loginResponse.User.Email</p>
                </div>
            }
            
            <div class="divider">
                <span>Made by Matteo Habsburg-Lothringen</span>
            </div>
        </EditForm>
    </div>
</div>

@code
{
    private readonly LoginRequest _login = new();
    private LoginResponse? _loginResponse;
    private bool _rememberMe;
    private bool _isSubmitting;
    private string? _error;

    private string _buttonText => _isSubmitting ? "Signing in..." : "Sign In";

    private async Task ValidateUser()
    {
        _error = null;
        _loginResponse = null;
        _isSubmitting = true;

        try
        {
            var response = await HttpClient.PostAsJsonAsync("api/User/login", new LogInUserCommand(_login.Identifier, _login.Password));

            if (response.IsSuccessStatusCode)
            {
                _loginResponse = await response.Content.ReadFromJsonAsync<LoginResponse>();
                NavigationManager.NavigateTo("/"); 
            }
            else
            {
                var serverMessage = await response.Content.ReadAsStringAsync();
                _error = string.IsNullOrWhiteSpace(serverMessage) ? "Invalid credentials." : serverMessage;
            }
        }
        catch (HttpRequestException exception)
        {
            _error = $"Request failed: {exception.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private sealed record LoginRequest
    {
        [Required(ErrorMessage = "Email is required.")]
        [EmailAddress(ErrorMessage = "Enter a valid email address.")]
        public string Identifier { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required.")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters.")]
        public string Password { get; set; } = string.Empty;
    }
    
    private sealed record LoginResponse(string AccessToken, string RefreshToken, UserDto User);

    private sealed record LogInUserCommand(string Identifier, string Password);
}