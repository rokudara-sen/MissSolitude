@layout LoginLayout
@inject NavigationManager NavigationManager
@page "/register"
@using System.ComponentModel.DataAnnotations
@inject HttpClient HttpClient

<PageTitle>Register</PageTitle>

<div class="auth-layout">
    <div class="auth-card">

        <div class="auth-header">
            <h1>Create your account</h1>
            <p>Enter your details to get started.</p>
        </div>

        <EditForm Model="_register" OnValidSubmit="@RegisterUser">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="field">
                <label for="username">Username</label>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M4 21v-2a4 4 0 0 1 3-3.87" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>

                    <InputText id="username"
                               @bind-Value="_register.Username"
                               class="input"
                               placeholder="Choose a username"
                               autocomplete="username" />
                </div>
                <ValidationMessage For="@(() => _register.Username)" />
            </div>

            <div class="field">
                <label for="email">Email Address</label>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="20" height="16" x="2" y="4" rx="2" />
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                    </svg>

                    <InputText id="email"
                               type="email"
                               @bind-Value="_register.Email.Value"
                               class="input"
                               placeholder="name@company.com"
                               autocomplete="email" />
                </div>
                <ValidationMessage For="@(() => _register.Email.Value)" />
            </div>

            <div class="field">
                <label for="password">Password</label>
                <div class="input-group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                    </svg>

                    <InputText id="password"
                               type="password"
                               @bind-Value="_register.Password"
                               class="input"
                               placeholder="Create a password"
                               autocomplete="new-password" />
                </div>
                <ValidationMessage For="@(() => _register.Password)" />
            </div>

            <button type="submit" class="btn btn-primary" disabled="@_isSubmitting">
                @ButtonText
            </button>

            @if (!string.IsNullOrWhiteSpace(_error))
            {
                <p class="error">@_error</p>
            }

            @if (_registerResponse is not null)
            {
                <div class="success">
                    <p>Account created for @_registerResponse.Username.</p>
                    <a href="/login" class="link-reset">Sign in to continue</a>
                </div>
            }

            <div class="divider">
                <span>Made by Matteo Habsburg-Lothringen</span>
            </div>
        </EditForm>
    </div>
</div>

@code
{
    private readonly RegisterRequest _register = new();
    private RegisterResponse? _registerResponse;
    private bool _isSubmitting;
    private string? _error;

    private string ButtonText => _isSubmitting ? "Registering..." : "Create Account";

    private async Task RegisterUser()
    {
        _error = null;
        _registerResponse = null;
        _isSubmitting = true;

        try
        {
            var response = await HttpClient.PostAsJsonAsync("api/User/register", _register);

            if (response.IsSuccessStatusCode)
            {
                _registerResponse = await response.Content.ReadFromJsonAsync<RegisterResponse>();
            }
            else
            {
                var serverMessage = await response.Content.ReadAsStringAsync();
                _error = string.IsNullOrWhiteSpace(serverMessage) ? "Unable to register with the provided details." : serverMessage;
            }
        }
        catch (HttpRequestException exception)
        {
            _error = $"Request failed: {exception.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private sealed record RegisterRequest
    {
        [Required(ErrorMessage = "Username is required.")]
        [MinLength(3, ErrorMessage = "Username must be at least 3 characters.")]
        public string Username { get; set; } = string.Empty;

        [Required]
        public EmailPayload Email { get; set; } = new();

        [Required(ErrorMessage = "Password is required.")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters.")]
        public string Password { get; set; } = string.Empty;
    }

    private sealed record EmailPayload
    {
        [Required(ErrorMessage = "Email is required.")]
        [EmailAddress(ErrorMessage = "Enter a valid email address.")]
        public string Value { get; set; } = string.Empty;
    }

    private sealed record RegisterResponse(Guid Id, string Username, EmailPayload Email);
}